<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>dotty - Rabbit Health Tracker</title>
    
    <!-- Favicon (Raw URL for direct image access) -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/conizm/dotty/main/images/dotty_logo_favi.png">
    
    <!-- OGP Settings -->
    <meta property="og:title" content="dotty - Rabbit Health Tracker">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://conizm.cc/dotty/">
    <meta property="og:image" content="https://conizm.cc/dotty/images/dotty_logo_ogp.png">
    <meta property="og:description" content="Simple health tracker for rabbits.">
    <meta name="theme-color" content="#8FB092">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map for React modules -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>

    <style>
        body {
            background-color: #FDFDFD;
            font-family: sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        /* Custom scrollbar hiding */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .pb-safe-content { padding-bottom: 80px; }
        
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes scale-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-slide-up { animation: slide-up 0.2s ease-out forwards; }
        .animate-scale-in { animation: scale-in 0.2s ease-out forwards; }
        
        @media print {
            body, main { 
                height: auto !important; 
                overflow: visible !important; 
                display: block !important;
            }
            .print\:hidden { display: none !important; }
            .print\:space-y-2 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.5rem; }
            .print\:border-stone-200 { border-color: #e5e7eb; }
            .print\:shadow-none { box-shadow: none; }
            .print\:break-inside-avoid { break-inside: avoid; }
            .print\:max-w-none { max-width: none; }
            .print\:px-0 { padding-left: 0; padding-right: 0; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Calendar, 
            Settings, 
            Plus, 
            Droplet, 
            Pill, 
            Syringe, 
            Carrot, 
            Activity, 
            Trash2, 
            ChevronRight, 
            Utensils, 
            ClipboardList, 
            Heart, 
            Printer, 
            Edit2, 
            Check, 
            X, 
            FileText, 
            ChevronLeft, 
            History, 
            Save 
        } from 'lucide-react';

        // --- Configuration ---

        const ACCENT_COLOR = '#8FB092';

        const STRINGS = {
            tab_today: 'Today',
            tab_history: 'History',
            tab_sitter: 'Sitter',
            tab_profile: 'Profile',
            save: 'Save',
            cancel: 'Cancel',
            edit: 'Edit',
            delete: 'Delete',
            notes: 'Notes',
            amount: 'Amount',
            time: 'Time',
            gender: 'Gender',
            male: 'Male',
            female: 'Female',
            guide: 'Care Guide',
            print: 'Save as PDF',
            name: 'Name',
            weight: 'Weight',
            birthday: 'Birthday',
            likes: 'Favorites',
            memo: 'Memo',
            custom_title: 'Custom Entry',
            select_type: 'Select Category',
            no_logs: 'No logs yet',
            back: 'Back',
            confirm_delete: 'Delete this item?',
            categories: {
                pellets: 'Pellets',
                veggies: 'Veggies',
                water: 'Water',
                hay: 'Hay',
                treats: 'Treats',
                meds: 'Medication',
                cc: 'Critical Care',
                poop: 'Poop',
                pee: 'Pee',
                custom: 'Custom',
                weight: 'Weight Check'
            },
            sitter_sections: {
                water: 'Water Change',
                hay: 'Refill Hay',
                litter: 'Litter Box',
                play: 'Playtime',
                emergency: 'Emergency Contact'
            }
        };

        const LOG_TYPES = [
            { id: 'pellets', icon: Utensils },
            { id: 'veggies', icon: Carrot },
            { id: 'hay', icon: FileText },
            { id: 'water', icon: Droplet },
            { id: 'cc', icon: Syringe },
            { id: 'meds', icon: Pill },
            { id: 'poop', icon: Activity },
            { id: 'pee', icon: Droplet },
            { id: 'custom', icon: Edit2 },
        ];

        // --- Reusable Components ---

        const Button = ({ children, onClick, variant = 'primary', className = '', ...props }) => {
            const baseStyle = "px-4 py-3 rounded-xl font-medium transition-all active:scale-95 flex items-center justify-center gap-2";
            const variants = {
                primary: `text-white shadow-sm hover:opacity-90`,
                secondary: "bg-stone-100 text-stone-600 border border-stone-200 shadow-sm",
                ghost: "bg-transparent text-stone-500 hover:bg-stone-100",
                icon: "p-2 rounded-full hover:bg-stone-100 text-stone-600"
            };

            const style = variant === 'primary' ? { backgroundColor: ACCENT_COLOR } : {};

            return (
                <button 
                onClick={onClick} 
                className={`${baseStyle} ${variants[variant]} ${className}`}
                style={style}
                {...props}
                >
                {children}
                </button>
            );
        };

        const EditToggleButton = ({ isEditing, onClick }) => (
            <button 
                onClick={onClick} 
                className={`p-2 rounded-full transition-colors ${isEditing ? 'text-white' : 'text-stone-400 hover:text-stone-600 hover:bg-stone-100'}`}
                style={isEditing ? { backgroundColor: ACCENT_COLOR } : {}}
            >
                {isEditing ? <Check size={20} /> : <Edit2 size={20} />}
            </button>
        );

        const Card = ({ children, className = '', onClick }) => (
            <div 
                onClick={onClick}
                className={`bg-white rounded-xl p-5 shadow-sm border border-stone-100 ${className} ${onClick ? 'cursor-pointer active:bg-stone-50 transition-colors' : ''}`}
            >
                {children}
            </div>
        );

        // --- Helper Functions ---

        const parseLocalDate = (dateString) => {
            if (!dateString) return new Date();
            const [year, month, day] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day);
        };

        const getLocalDateString = (d) => {
            const date = new Date(d);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- Sub-Components ---

        const Timeline = ({ 
            logs, 
            dateKey, 
            onDateChange,
            onDeleteLog, 
            onEditLog,
            onIconChange,
            isHistoryView = false 
        }) => {
            const [isEditing, setIsEditing] = useState(false);

            const formatTime = (isoString) => new Intl.DateTimeFormat('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }).format(new Date(isoString));
            const formatDate = (dateObj) => new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'short', day: 'numeric' }).format(dateObj);

            const dayLogs = logs.filter(log => getLocalDateString(log.date) === dateKey)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const handleDateHeaderChange = (e) => {
                if (onDateChange) {
                    onDateChange(dateKey, e.target.value);
                }
            };

            const cycleIcon = (log) => {
                if (!isEditing || !onIconChange) return;
                const currentTypeIndex = LOG_TYPES.findIndex(t => t.id === log.type);
                const nextType = LOG_TYPES[(currentTypeIndex + 1) % LOG_TYPES.length];
                onIconChange(log.id, nextType.id);
            };

            return (
                <div className="space-y-4 print:space-y-2 pb-safe-content">
                <div className="flex justify-between items-end px-2 mb-6 print:mb-2">
                    <div className="w-full">
                        {isHistoryView && (
                            <div className="text-sm text-stone-400 font-medium uppercase tracking-wider mb-1">
                                {STRINGS.tab_history}
                            </div>
                        )}
                    
                        {isEditing ? (
                            <input 
                            type="date" 
                            value={dateKey} 
                            onChange={handleDateHeaderChange}
                            className="text-2xl font-bold text-stone-800 bg-stone-100 rounded px-2 py-1 -ml-2 w-full outline-none focus:ring-2 focus:ring-[#8FB092]"
                            />
                        ) : (
                            <h2 className="text-3xl font-bold text-stone-800 tracking-tight">
                                {formatDate(parseLocalDate(dateKey))}
                            </h2>
                        )}
                    </div>

                    <div className="flex items-center gap-2 print:hidden ml-4">
                        <EditToggleButton isEditing={isEditing} onClick={() => setIsEditing(!isEditing)} />
                    </div>
                </div>

                {dayLogs.length === 0 ? (
                    <div className="text-center py-20 text-stone-300">
                    <p>{STRINGS.no_logs}</p>
                    </div>
                ) : (
                    <div className="space-y-3 relative before:absolute before:left-[19px] before:top-4 before:bottom-4 before:w-[2px] before:bg-stone-100">
                    {dayLogs.map((log) => {
                        const typeConfig = LOG_TYPES.find(l => l.id === log.type) || LOG_TYPES[LOG_TYPES.length - 1];
                        const Icon = typeConfig.icon;
                        
                        return (
                        <div key={log.id} className="relative flex gap-4 items-center pl-0 print:break-inside-avoid">
                            <button 
                            onClick={(e) => {
                                if (isEditing) {
                                    e.stopPropagation();
                                    cycleIcon(log);
                                }
                            }}
                            disabled={!isEditing}
                            className={`z-10 w-10 h-10 rounded-full flex items-center justify-center shrink-0 shadow-sm text-white transition-transform ${isEditing ? 'active:scale-90 hover:opacity-80 cursor-pointer' : ''}`}
                            style={{ backgroundColor: ACCENT_COLOR }}
                            >
                            <Icon size={18} strokeWidth={2} />
                            </button>
                            
                            <div 
                            className={`flex-1 bg-white rounded-xl p-4 border border-stone-100 shadow-sm print:border-stone-200 print:shadow-none flex justify-between items-start ${isEditing ? 'cursor-pointer hover:bg-stone-50' : ''}`}
                            onClick={() => isEditing && onEditLog(log)}
                            >
                            <div className="flex-1">
                                <div className="flex justify-between items-start mb-1">
                                <span className="font-bold text-stone-700 text-sm">
                                    {STRINGS.categories[log.type]}
                                </span>
                                <span className="text-xs font-mono text-stone-400">
                                    {formatTime(log.date)}
                                </span>
                                </div>
                                {(log.amount || log.notes) && (
                                <div className="text-sm text-stone-600 leading-relaxed">
                                    {log.amount && <span className="font-medium mr-2">{log.amount}</span>}
                                    {log.notes && <span className="text-stone-500">{log.notes}</span>}
                                </div>
                                )}
                            </div>

                            {isEditing && (
                                <button 
                                onClick={(e) => { 
                                    e.stopPropagation(); 
                                    onDeleteLog(log.id); 
                                }}
                                className="ml-2 p-2 text-stone-300 hover:text-red-500 transition-colors z-20"
                                >
                                <Trash2 size={18} />
                                </button>
                            )}
                            </div>
                        </div>
                        );
                    })}
                    </div>
                )}
                </div>
            );
        };

        const HistoryScreen = ({ logs, onSelectDate }) => {
            const formatDate = (isoString) => new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'short', day: 'numeric' }).format(parseLocalDate(isoString));
            
            const dates = [...new Set(logs.map(log => getLocalDateString(log.date)))].sort().reverse();

            return (
                <div className="space-y-4 pb-safe-content">
                <h2 className="text-2xl font-bold text-stone-800 px-2 mb-6">{STRINGS.tab_history}</h2>
                {dates.map(dateKey => (
                    <Card key={dateKey} onClick={() => onSelectDate(dateKey)} className="flex items-center justify-between group">
                    <div>
                        <div className="font-bold text-stone-700">{formatDate(dateKey)}</div>
                        <div className="text-xs text-stone-400 mt-1">
                        {logs.filter(l => getLocalDateString(l.date) === dateKey).length} Records
                        </div>
                    </div>
                    <ChevronRight className="text-stone-300 group-hover:text-stone-500 transition-colors" size={20} />
                    </Card>
                ))}
                </div>
            );
        };

        const SitterScreen = ({ careGuideItems, setCareGuideItems, emergencyContact, setEmergencyContact }) => {
            const [isEditingGuide, setIsEditingGuide] = useState(false);

            const handleGuideChange = (index, field, newVal) => {
                const newItems = [...careGuideItems];
                newItems[index][field] = newVal;
                setCareGuideItems(newItems);
            };

            const cycleIcon = (index) => {
                if (!isEditingGuide) return;
                const currentItem = careGuideItems[index];
                const currentTypeIndex = LOG_TYPES.findIndex(t => t.id === currentItem.id);
                const nextType = LOG_TYPES[(currentTypeIndex + 1) % LOG_TYPES.length];
                
                const newItems = [...careGuideItems];
                newItems[index].id = nextType.id;
                setCareGuideItems(newItems);
            };

            const deleteItem = (index) => {
                const newItems = careGuideItems.filter((_, i) => i !== index);
                setCareGuideItems(newItems);
            };

            const addItem = () => {
                setCareGuideItems([...careGuideItems, { id: 'pellets', text: '' }]);
            };

            return (
                <div className="pb-safe-content space-y-3">
                <div className="flex items-center justify-between px-2 mb-4">
                    <h2 className="text-2xl font-bold text-stone-800">{STRINGS.guide}</h2>
                    <div className="flex items-center gap-2 print:hidden">
                        <EditToggleButton isEditing={isEditingGuide} onClick={() => setIsEditingGuide(!isEditingGuide)} />
                    </div>
                </div>

                {careGuideItems.map((item, idx) => {
                    const typeConfig = LOG_TYPES.find(t => t.id === item.id) || LOG_TYPES[0];
                    const Icon = typeConfig.icon;

                    return (
                    <div key={idx} className="flex gap-4 items-start p-4 bg-white rounded-xl border border-stone-100 print:border-stone-300 animate-scale-in">
                        <button 
                        onClick={() => cycleIcon(idx)}
                        disabled={!isEditingGuide}
                        className={`p-2 rounded-lg shrink-0 text-white transition-transform ${isEditingGuide ? 'active:scale-90 hover:opacity-80' : ''}`} 
                        style={{ backgroundColor: ACCENT_COLOR }}
                        >
                        <Icon size={20} strokeWidth={2} />
                        </button>
                        <div className="flex-1">
                        <h3 className="font-bold text-stone-700 text-sm mb-1">{STRINGS.sitter_sections[item.id] || STRINGS.categories[item.id]}</h3>
                        {isEditingGuide ? (
                            <textarea
                            value={item.text}
                            onChange={(e) => handleGuideChange(idx, 'text', e.target.value)}
                            className="w-full text-sm bg-stone-50 border border-stone-200 rounded p-2 focus:outline-none focus:border-[#8FB092] resize-none"
                            rows={2}
                            />
                        ) : (
                            <p className="text-stone-600 text-sm leading-relaxed">
                            {item.text}
                            </p>
                        )}
                        </div>
                        
                        {isEditingGuide && (
                        <button onClick={() => deleteItem(idx)} className="text-stone-300 hover:text-red-500 self-center p-2">
                            <Trash2 size={18} />
                        </button>
                        )}
                    </div>
                    );
                })}

                {isEditingGuide && (
                    <Button variant="secondary" onClick={addItem} className="w-full border-dashed">
                    <Plus size={18} /> Add Item
                    </Button>
                )}

                <div className="mt-8 p-5 bg-stone-50 rounded-xl border-l-4 border-[#8FB092] print:border-gray-400">
                    <h3 className="font-bold text-stone-700 mb-2 flex items-center gap-2">
                    <Activity size={18} className="text-[#8FB092]" />
                    {STRINGS.sitter_sections.emergency}
                    </h3>
                    {isEditingGuide ? (
                    <textarea
                        value={emergencyContact}
                        onChange={(e) => setEmergencyContact(e.target.value)}
                        className="w-full text-sm bg-white border border-stone-200 rounded p-2 focus:outline-none focus:border-[#8FB092]"
                        rows={4}
                    />
                    ) : (
                    <p className="text-stone-600 text-sm whitespace-pre-line leading-relaxed">
                        {emergencyContact}
                    </p>
                    )}
                </div>
                </div>
            );
        };

        const ProfileScreen = ({ profile, setProfile }) => {
            const [isEditingProfile, setIsEditingProfile] = useState(false);
            const [tempProfile, setTempProfile] = useState({});

            const handleSaveProfile = () => {
                setProfile(tempProfile);
                setIsEditingProfile(false);
            };

            const startEditing = () => {
                setTempProfile({ ...profile });
                setIsEditingProfile(true);
            };

            return (
                <div className="pb-safe-content space-y-6">
                <div className="flex justify-between items-center px-2">
                    <h2 className="text-2xl font-bold text-stone-800">{STRINGS.tab_profile}</h2>
                    <div className="print:hidden">
                        <EditToggleButton isEditing={isEditingProfile} onClick={isEditingProfile ? handleSaveProfile : startEditing} />
                    </div>
                </div>

                <div className="flex flex-col items-center py-6">
                    {!isEditingProfile ? (
                        <div className="text-center">
                            <h3 className="text-3xl font-bold text-stone-800">{profile.name}</h3>
                            <div className="text-stone-500 mt-2 flex items-center justify-center gap-2">
                                <span>{profile.gender === 'male' ? STRINGS.male : STRINGS.female}</span>
                                <span>â€¢</span>
                                <span>{new Date().getFullYear() - new Date(profile.birthday).getFullYear()} y</span>
                            </div>
                        </div>
                    ) : (
                        <input 
                            type="text" 
                            value={tempProfile.name} 
                            onChange={e => setTempProfile({...tempProfile, name: e.target.value})}
                            className="text-center text-xl font-bold bg-stone-50 border-b border-stone-300 focus:border-[#8FB092] outline-none px-2 py-1 w-2/3"
                        />
                    )}
                </div>

                <div className="grid grid-cols-1 gap-4">
                    {isEditingProfile && (
                        <Card className="flex items-center justify-between">
                            <span className="text-sm text-stone-400">{STRINGS.gender}</span>
                            <div className="flex gap-2">
                                <button 
                                    onClick={() => setTempProfile({...tempProfile, gender: 'male'})}
                                    className={`px-3 py-1 rounded-lg text-sm ${tempProfile.gender === 'male' ? 'bg-[#8FB092] text-white' : 'bg-stone-100 text-stone-400'}`}
                                >
                                    {STRINGS.male}
                                </button>
                                <button 
                                    onClick={() => setTempProfile({...tempProfile, gender: 'female'})}
                                    className={`px-3 py-1 rounded-lg text-sm ${tempProfile.gender === 'female' ? 'bg-[#8FB092] text-white' : 'bg-stone-100 text-stone-400'}`}
                                >
                                    {STRINGS.female}
                                </button>
                            </div>
                        </Card>
                    )}

                    <Card className="flex items-center justify-between">
                        <span className="text-sm text-stone-400 font-medium uppercase">{STRINGS.birthday}</span>
                        {isEditingProfile ? (
                            <input 
                                type="date" 
                                value={tempProfile.birthday} 
                                onChange={e => setTempProfile({...tempProfile, birthday: e.target.value})}
                                className="bg-stone-50 rounded px-2 py-1 text-right outline-none text-stone-700"
                            />
                        ) : (
                            <span className="font-medium text-stone-700">{profile.birthday}</span>
                        )}
                    </Card>

                    <Card className="flex items-center justify-between">
                        <span className="text-sm text-stone-400 font-medium uppercase">{STRINGS.weight}</span>
                        {isEditingProfile ? (
                            <input 
                                type="text" 
                                value={tempProfile.weight} 
                                onChange={e => setTempProfile({...tempProfile, weight: e.target.value})}
                                className="bg-stone-50 rounded px-2 py-1 text-right outline-none text-stone-700 w-24"
                            />
                        ) : (
                            <span className="font-medium text-stone-700">{profile.weight}</span>
                        )}
                    </Card>

                    <Card>
                        <span className="text-sm text-stone-400 font-medium uppercase block mb-3">{STRINGS.likes}</span>
                        {isEditingProfile ? (
                            <textarea 
                                value={tempProfile.likes} 
                                onChange={e => setTempProfile({...tempProfile, likes: e.target.value})}
                                className="w-full bg-stone-50 rounded p-2 text-stone-700 outline-none"
                                rows={3}
                            />
                        ) : (
                            <div className="flex flex-wrap gap-2">
                                {profile.likes.split(',').map((like, i) => (
                                    <span key={i} className="px-3 py-1 bg-stone-100 text-stone-600 rounded-lg text-sm">
                                        {like.trim()}
                                    </span>
                                ))}
                            </div>
                        )}
                    </Card>

                    <Card>
                        <span className="text-sm text-stone-400 font-medium uppercase block mb-3">{STRINGS.memo}</span>
                        {isEditingProfile ? (
                            <textarea 
                                value={tempProfile.memo} 
                                onChange={e => setTempProfile({...tempProfile, memo: e.target.value})}
                                className="w-full bg-stone-50 rounded p-2 text-stone-700 outline-none"
                                rows={4}
                                placeholder="Add notes..."
                            />
                        ) : (
                            <div className="text-stone-600 text-sm whitespace-pre-line leading-relaxed">
                                {profile.memo || "No memo"}
                            </div>
                        )}
                    </Card>
                </div>
                </div>
            );
        };

        const App = () => {
            const getTodayKey = () => getLocalDateString(new Date());

            const [activeTab, setActiveTab] = useState('today');
            const [selectedDateKey, setSelectedDateKey] = useState(getTodayKey()); 
            const [selectedHistoryDate, setSelectedHistoryDate] = useState(null); // Fixed ReferenceError
            
            const [isFabOpen, setIsFabOpen] = useState(false);
            const [modalOpen, setModalOpen] = useState(false);
            const [selectedLogType, setSelectedLogType] = useState(null);
            const [editLogData, setEditLogData] = useState(null); 

            const [logs, setLogs] = useState([
                { id: 1, type: 'pellets', amount: '15g', date: new Date().toISOString(), notes: '' },
                { id: 2, type: 'poop', amount: 'Normal', date: new Date(Date.now() - 3600000).toISOString(), notes: 'Good size' },
                { id: 3, type: 'cc', amount: '10ml', date: new Date(Date.now() - 7200000).toISOString(), notes: 'Force feed' },
            ]);

            const [profile, setProfile] = useState({
                name: 'Mugi',
                gender: 'Male',
                birthday: '2019-09-15',
                weight: '1.8kg',
                likes: 'Dill, Rettuce',
                memo: '',
                photo: null
            });

            const [careGuideItems, setCareGuideItems] = useState([
                { id: 'water', text: 'Fresh water twice a day (Morning/Night).' },
                { id: 'hay', text: 'Unlimited Timothy hay. Never let it run out.' },
                { id: 'pellets', text: '2 tablespoons in the morning.' },
                { id: 'litter', text: 'Change litter daily. Monitor poop size.' },
                { id: 'play', text: 'At least 1 hour of playtime outside cage.' }
            ]);
            const [emergencyContact, setEmergencyContact] = useState(`Clinic: ABC Exotics Vet\nPhone: 123-456-7890\nAddress: 123 Rabbit Lane, Toronto\nOwner: 090-0000-0000 (Line/WhatsApp)`);

            const handlePrint = () => {
                window.print();
            };

            const handleAddLogClick = (typeId) => {
                setSelectedLogType(typeId);
                setEditLogData(null); 
                setIsFabOpen(false);
                setModalOpen(true);
            };

            const handleDeleteLog = useCallback((id) => {
                if (window.confirm(STRINGS.confirm_delete)) {
                    setLogs((prev) => prev.filter(l => l.id !== id));
                }
            }, []);

            const handleEditLog = useCallback((log) => {
                setSelectedLogType(log.type);
                setEditLogData(log);
                setModalOpen(true);
            }, []);

            const handleIconChange = useCallback((logId, newTypeId) => {
                setLogs((prev) => prev.map(log => 
                    log.id === logId ? { ...log, type: newTypeId } : log
                ));
            }, []);

            const handleDateChange = (oldDateKey, newDateString) => {
                setLogs((prev) => prev.map(log => {
                    const logDateKey = getLocalDateString(log.date);

                    if (logDateKey === oldDateKey) {
                        const logDate = new Date(log.date);
                        const hours = logDate.getHours();
                        const minutes = logDate.getMinutes();
                        const seconds = logDate.getSeconds();
                        
                        const [ny, nm, nd] = newDateString.split('-').map(Number);
                        const newDate = new Date(ny, nm - 1, nd, hours, minutes, seconds);
                        
                        return { ...log, date: newDate.toISOString() };
                    }
                    return log;
                }));
                setSelectedDateKey(newDateString);
            };

            const saveLog = (data) => {
                let baseDate;
                if (editLogData) {
                    baseDate = new Date(editLogData.date);
                } else {
                    baseDate = parseLocalDate(selectedDateKey);
                    const now = new Date();
                    if (selectedDateKey === getTodayKey()) {
                        baseDate.setHours(now.getHours(), now.getMinutes());
                    } else {
                        baseDate.setHours(12, 0); 
                    }
                }

                const [hours, minutes] = data.time.split(':');
                baseDate.setHours(parseInt(hours), parseInt(minutes));

                if (editLogData) {
                    setLogs((prev) => prev.map(l => l.id === editLogData.id ? {
                        ...l,
                        type: selectedLogType,
                        date: baseDate.toISOString(),
                        amount: data.amount,
                        notes: data.notes
                    } : l));
                } else {
                    const newLog = {
                        id: Date.now(),
                        type: selectedLogType,
                        date: baseDate.toISOString(),
                        amount: data.amount,
                        notes: data.notes
                    };
                    setLogs((prev) => [newLog, ...prev]);
                }
                
                setModalOpen(false);
                setEditLogData(null);
            };

            const FabMenu = () => {
                if (!isFabOpen) return null;
                return (
                <>
                    <div className="fixed inset-0 bg-stone-900/20 backdrop-blur-[1px] z-40 transition-opacity" onClick={() => setIsFabOpen(false)} />
                    <div className="fixed bottom-24 right-6 z-50 flex flex-col items-end gap-3 animate-slide-up origin-bottom-right">
                        <div className="bg-white rounded-xl shadow-xl border border-stone-100 p-2 min-w-[200px] flex flex-col gap-1">
                            <div className="px-3 py-2 text-xs font-bold text-stone-400 uppercase tracking-wider">{STRINGS.select_type}</div>
                            {LOG_TYPES.map((type) => (
                                <button 
                                    key={type.id}
                                    onClick={() => handleAddLogClick(type.id)}
                                    className="w-full flex items-center gap-3 px-3 py-3 hover:bg-stone-50 rounded-lg transition-colors text-left"
                                >
                                    <div className="p-1.5 rounded-lg text-white shrink-0" style={{ backgroundColor: ACCENT_COLOR }}>
                                        <type.icon size={18} />
                                    </div>
                                    <span className="text-stone-700 font-medium text-sm">{STRINGS.categories[type.id]}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                </>
                );
            };

            const EntryModal = () => {
                if (!modalOpen) return null;
                const type = LOG_TYPES.find(t => t.id === selectedLogType);
                if (!type) return null;
                const Icon = type.icon;
                
                let initialTimeStr;
                if (editLogData) {
                    const d = new Date(editLogData.date);
                    initialTimeStr = `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
                } else {
                    const now = new Date();
                    initialTimeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                }

                return (
                <div className="fixed inset-0 z-50 flex items-start justify-center p-4 pt-10">
                    <div className="absolute inset-0 bg-stone-900/30 backdrop-blur-sm transition-opacity" onClick={() => setModalOpen(false)} />
                    <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl relative z-10 animate-scale-in">
                        <div className="flex justify-between items-center mb-6">
                            <div className="flex items-center gap-3">
                                <div className="p-2 rounded-lg text-white" style={{ backgroundColor: ACCENT_COLOR }}>
                                    <Icon size={24} />
                                </div>
                                <h3 className="text-lg font-bold text-stone-800">
                                    {editLogData ? STRINGS.edit : ''} {STRINGS.categories[type.id]}
                                </h3>
                            </div>
                            <button onClick={() => setModalOpen(false)} className="p-1 rounded-full hover:bg-stone-100 text-stone-400">
                                <X size={24} />
                            </button>
                        </div>

                        <form onSubmit={(e) => {
                            e.preventDefault();
                            const formData = new FormData(e.target);
                            saveLog({
                                amount: formData.get('amount'),
                                notes: formData.get('notes'),
                                time: formData.get('time')
                            });
                        }} className="space-y-4">
                            
                            <div className="flex gap-4">
                                <div className="w-1/3">
                                    <label className="block text-xs font-bold text-stone-400 uppercase mb-1">{STRINGS.time}</label>
                                    <input 
                                        name="time" 
                                        type="time" 
                                        defaultValue={initialTimeStr}
                                        className="w-full bg-stone-50 border border-stone-200 rounded-lg px-3 py-3 text-stone-700 focus:outline-none focus:border-[#8FB092] h-[50px]" 
                                    />
                                </div>
                                <div className="flex-1">
                                    <label className="block text-xs font-bold text-stone-400 uppercase mb-1">{STRINGS.amount}</label>
                                    <input 
                                        name="amount" 
                                        type="text" 
                                        defaultValue={editLogData ? editLogData.amount : ''}
                                        placeholder="..."
                                        className="w-full bg-stone-50 border border-stone-200 rounded-lg px-3 py-3 text-stone-700 focus:outline-none focus:border-[#8FB092] h-[50px]" 
                                        autoFocus
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-stone-400 uppercase mb-1">{STRINGS.notes}</label>
                                <textarea 
                                    name="notes"
                                    defaultValue={editLogData ? editLogData.notes : ''}
                                    rows="3"
                                    className="w-full bg-stone-50 border border-stone-200 rounded-lg px-3 py-2 text-stone-700 focus:outline-none focus:border-[#8FB092] resize-none" 
                                />
                            </div>

                            <div className="pt-2">
                                <Button type="submit" variant="primary" className="w-full">
                                    {STRINGS.save}
                                </Button>
                            </div>
                        </form>
                    </div>
                </div>
                );
            };

            const NavIcon = ({ icon: Icon, isActive, onClick }) => (
                <button 
                    onClick={onClick}
                    className={`flex items-center justify-center p-2 rounded-xl transition-all duration-300 ${isActive ? 'text-[#8FB092] bg-stone-50' : 'text-stone-300 hover:text-stone-400'}`}
                >
                    <Icon size={26} strokeWidth={isActive ? 2.5 : 2} />
                </button>
            );

            return (
                <div className="h-screen flex flex-col bg-[#FDFDFD] font-sans text-[#44403C] overflow-hidden print:bg-white print:h-auto print:overflow-visible">
                    <header className="flex-none bg-[#FDFDFD]/90 backdrop-blur-md px-4 py-3 flex justify-between items-center border-b border-stone-100 z-30 print:hidden">
                        <div className="flex items-center gap-2">
                        <img 
                            src="https://conizm.cc/dotty/images/dotty_logo_yoko.png" 
                            alt="Logo" 
                            className="h-8 object-contain" 
                        />
                        </div>

                        <div className="flex gap-2">
                            <button onClick={handlePrint} className="p-2 rounded-full text-stone-400 hover:bg-stone-100 transition-colors flex items-center gap-2 text-sm font-medium">
                                <Printer size={20} />
                            </button>
                        </div>
                    </header>

                    <main className="flex-1 overflow-y-auto overflow-x-hidden px-4 py-6 max-w-md mx-auto w-full print:max-w-none print:px-0 print:py-0 print:overflow-visible no-scrollbar">
                        {activeTab === 'today' && (
                            <Timeline 
                                logs={logs} 
                                dateKey={selectedDateKey} 
                                onDeleteLog={handleDeleteLog}
                                onEditLog={handleEditLog}
                                onDateChange={handleDateChange}
                                onIconChange={handleIconChange}
                            />
                        )}
                        
                        {activeTab === 'history' && !selectedHistoryDate && (
                        <HistoryScreen logs={logs} onSelectDate={(date) => {
                            setSelectedHistoryDate(date);
                            setSelectedDateKey(date);
                            setActiveTab('today'); 
                        }} />
                        )}

                        {activeTab === 'sitter' && (
                        <SitterScreen 
                            careGuideItems={careGuideItems} 
                            setCareGuideItems={setCareGuideItems} 
                            emergencyContact={emergencyContact}
                            setEmergencyContact={setEmergencyContact}
                        />
                        )}
                        
                        {activeTab === 'profile' && <ProfileScreen profile={profile} setProfile={setProfile} />}
                    </main>

                    {!isFabOpen && (activeTab === 'today') && (
                        <button 
                        onClick={() => setIsFabOpen(true)}
                        className="fixed bottom-24 right-6 z-30 w-14 h-14 bg-[#8FB092] rounded-2xl shadow-lg shadow-[#8FB092]/30 text-white flex items-center justify-center transition-transform active:scale-90 print:hidden"
                        >
                        <Plus size={28} strokeWidth={2.5} />
                        </button>
                    )}

                    <FabMenu />
                    <EntryModal />

                    <nav className="flex-none bg-white border-t border-stone-100 px-6 py-3 pb-safe z-30 print:hidden">
                        <div className="max-w-md mx-auto flex justify-between items-center">
                        <NavIcon 
                            icon={Calendar} 
                            isActive={activeTab === 'today' && selectedDateKey === getTodayKey()} 
                            onClick={() => { setActiveTab('today'); setSelectedDateKey(getTodayKey()); setIsFabOpen(false); setSelectedHistoryDate(null); }} 
                        />
                        <NavIcon 
                            icon={History} 
                            isActive={activeTab === 'history' || (activeTab === 'today' && selectedDateKey !== getTodayKey())} 
                            onClick={() => { setActiveTab('history'); setSelectedHistoryDate(null); setIsFabOpen(false); }} 
                        />
                        <NavIcon 
                            icon={ClipboardList} 
                            isActive={activeTab === 'sitter'} 
                            onClick={() => { setActiveTab('sitter'); setIsFabOpen(false); setSelectedHistoryDate(null); }} 
                        />
                        <NavIcon 
                            icon={Settings} 
                            isActive={activeTab === 'profile'} 
                            onClick={() => { setActiveTab('profile'); setIsFabOpen(false); setSelectedHistoryDate(null); }} 
                        />
                        </div>
                    </nav>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
