<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dotty - Rabbit Health Tracker</title>
    
    <!-- Favicon (Raw URL for direct image access) -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/conizm/dotty/main/images/dotty_logo_favi.png">
    
    <!-- OGP Settings -->
    <meta property="og:title" content="dotty - Rabbit Health Tracker">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://conizm.cc/dotty/">
    <meta property="og:image" content="https://conizm.cc/dotty/images/dotty_logo_ogp.png">
    <meta property="og:description" content="Simple health tracker for rabbits.">
    <meta name="theme-color" content="#8FB092">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="dotty">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/conizm/dotty/main/images/dotty_logo_favi.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map for React modules -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>

    <style>
        body {
            background-color: #FDFDFD;
            font-family: sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        /* Custom scrollbar hiding */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .pb-safe { 
            padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 81px);
            background-color: #FDFDFD;
        }
        .pb-safe-content { padding-bottom: 80px; }
        
        /* アドレスバー出現時でもフッターが見えるように余白を追加 */
        body {
            padding-bottom: 150px;
        }
        
        /* selectタグのスタイリング */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
        
        /* Webで見たときのステータスバーの背景色 */
        html {
            background-color: #FDFDFD;
        }
        
        /* iOS PWAでキーボードが表示されるようにする */
        input, textarea {
            user-select: text !important;
            -webkit-user-select: text !important;
            -webkit-touch-callout: default !important;
            touch-action: manipulation;
            pointer-events: auto !important;
            -webkit-appearance: none;
            appearance: none;
        }
        
        input:focus, textarea:focus {
            user-select: text !important;
            -webkit-user-select: text !important;
            -webkit-touch-callout: default !important;
            pointer-events: auto !important;
            outline: none;
        }
        
        input:not([readonly]):not([disabled]), 
        textarea:not([readonly]):not([disabled]) {
            cursor: text;
        }
        
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes scale-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-slide-up { animation: slide-up 0.2s ease-out forwards; }
        .animate-scale-in { animation: scale-in 0.2s ease-out forwards; }
        
        @media print {
            body, main { 
                height: auto !important; 
                overflow: visible !important; 
                display: block !important;
            }
            .print\:hidden { display: none !important; }
            .print\:space-y-2 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.5rem; }
            .print\:border-stone-200 { border-color: #e5e7eb; }
            .print\:shadow-none { box-shadow: none; }
            .print\:break-inside-avoid { break-inside: avoid; }
            .print\:max-w-none { max-width: none; }
            .print\:px-0 { padding-left: 0; padding-right: 0; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useCallback, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Calendar, 
            Settings, 
            Plus, 
            Droplet, 
            Pill, 
            Syringe, 
            Carrot, 
            Activity, 
            Trash2, 
            ChevronRight, 
            Utensils, 
            ClipboardList, 
            Heart, 
            Printer, 
            Edit2, 
            Check, 
            X, 
            FileText, 
            ChevronLeft, 
            History, 
            Save,
            Wheat,
            Cake,
            Scale,
            Cookie
        } from 'lucide-react';

        // カスタムアイコン: うさぎのうんち（丸3つ・三角形配置）
        const RabbitPoop = ({ size = 24, strokeWidth = 2, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" {...props}>
                <circle cx="12" cy="7" r="3" />
                <circle cx="6.5" cy="16" r="3" />
                <circle cx="17.5" cy="16" r="3" />
            </svg>
        );

        // カスタムアイコン: 波線3本（Water用）
        const WaterBottleIcon = ({ size = 24, strokeWidth = 2, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M2 7c2 0 2-2 4-2s2 2 4 2 2-2 4-2 2 2 4 2 2-2 4-2 2 2 4 2" />
                <path d="M2 12c2 0 2-2 4-2s2 2 4 2 2-2 4-2 2 2 4 2 2-2 4-2 2 2 4 2" />
                <path d="M2 17c2 0 2-2 4-2s2 2 4 2 2-2 4-2 2 2 4 2 2-2 4-2 2 2 4 2" />
            </svg>
        );

        // カスタムアイコン: リターボックス（底の浅い角丸の箱）
        const LitterBoxIcon = ({ size = 24, strokeWidth = 2, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M3 11h18l-1.5 8a2 2 0 0 1-2 1.5H6.5a2 2 0 0 1-2-1.5L3 11z" />
                <path d="M5 11l1-3.5a1 1 0 0 1 1-.5h10a1 1 0 0 1 1 .5L19 11" />
            </svg>
        );

        // カスタムアイコン: 音符（Playtime）
        const MusicNoteIcon = ({ size = 24, strokeWidth = 2, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M9 18V5l12-2v13" />
                <circle cx="6" cy="18" r="3" />
                <circle cx="18" cy="16" r="3" />
            </svg>
        );

        // カスタムアイコン: うさぎ（フッター用）
        const RabbitIcon = ({ size = 24, strokeWidth = 2, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" {...props}>
                <ellipse cx="9" cy="5" rx="2" ry="5" />
                <ellipse cx="15" cy="5" rx="2" ry="5" />
                <circle cx="12" cy="14" r="6" />
                <circle cx="10" cy="12.5" r="0.5" fill="currentColor" />
                <circle cx="14" cy="12.5" r="0.5" fill="currentColor" />
                <ellipse cx="12" cy="14.5" rx="1" ry="0.5" />
            </svg>
        );

        // --- Configuration ---

        const ACCENT_COLOR = '#8FB092';

        const STRINGS = {
            tab_today: 'Today',
            tab_history: 'History',
            tab_sitter: 'Sitter',
            tab_profile: 'Profile',
            save: 'Save',
            cancel: 'Cancel',
            edit: 'Edit',
            delete: 'Delete',
            notes: 'Notes',
            amount: 'Amount',
            time: 'Time',
            gender: 'Gender',
            male: 'Male',
            female: 'Female',
            guide: 'Care Guide',
            print: 'Save as PDF',
            name: 'Name',
            weight: 'Weight',
            birthday: 'Birthday',
            likes: 'Favorites',
            memo: 'Memo',
            custom_title: 'Custom Entry',
            select_type: 'Select Category',
            no_logs: 'No logs yet',
            back: 'Back',
            confirm_delete: 'Delete this item?',
            categories: {
                pellets: 'Pellets',
                veggies: 'Veggies',
                water: 'Water',
                hay: 'Hay',
                treats: 'Treats',
                meds: 'Medication',
                cc: 'Critical Care',
                poop: 'Poop',
                pee: 'Pee',
                custom: 'Others',
                weight: 'Weight Check'
            },
            sitter_sections: {
                water: 'Water Change',
                hay: 'Refill Hay',
                litter: 'Litter Box',
                play: 'Playtime',
                others: 'Others',
                emergency: 'Emergency Contact'
            }
        };

        const LOG_TYPES = [
            { id: 'hay', icon: Wheat },
            { id: 'water', icon: WaterBottleIcon },
            { id: 'pellets', icon: Utensils },
            { id: 'veggies', icon: Carrot },
            { id: 'treats', icon: Cookie },
            { id: 'cc', icon: Syringe },
            { id: 'meds', icon: Pill },
            { id: 'poop', icon: RabbitPoop },
            { id: 'pee', icon: Droplet },
        ];

        // Sitter画面用アイコンマッピング（LOG_TYPESに加えて litter, play を含む）
        const SITTER_ICON_MAP = {
            hay: Wheat,
            water: WaterBottleIcon,
            pellets: Utensils,
            veggies: Carrot,
            treats: Cookie,
            cc: Syringe,
            meds: Pill,
            poop: RabbitPoop,
            pee: Droplet,
            litter: LitterBoxIcon,
            play: MusicNoteIcon,
        };

        // --- Reusable Components ---

        const Button = ({ children, onClick, variant = 'primary', className = '', ...props }) => {
            const baseStyle = "px-4 py-3 rounded-xl font-medium transition-all active:scale-95 flex items-center justify-center gap-2";
            const variants = {
                primary: `text-white shadow-sm hover:opacity-90`,
                secondary: "bg-stone-100 text-stone-600 border border-stone-200 shadow-sm",
                ghost: "bg-transparent text-stone-500 hover:bg-stone-100",
                icon: "p-2 rounded-full hover:bg-stone-100 text-stone-600"
            };

            const style = variant === 'primary' ? { backgroundColor: ACCENT_COLOR } : {};

            return (
                <button 
                onClick={onClick} 
                className={`${baseStyle} ${variants[variant]} ${className}`}
                style={style}
                {...props}
                >
                {children}
                </button>
            );
        };

        const EditToggleButton = ({ isEditing, onClick }) => (
            <button 
                onClick={onClick} 
                className={`p-2 rounded-full transition-colors ${isEditing ? 'text-white' : 'hover:text-stone-600 hover:bg-stone-100'}`}
                style={isEditing ? { backgroundColor: ACCENT_COLOR } : { color: 'rgba(120, 113, 108, 0.6)' }}
            >
                {isEditing ? <Check size={20} /> : <Edit2 size={20} style={{ opacity: 0.45 }} />}
            </button>
        );

        const Card = ({ children, className = '', onClick }) => (
            <div 
                onClick={onClick}
                className={`bg-white rounded-xl p-4 shadow-sm border border-stone-100 ${className} ${onClick ? 'cursor-pointer active:bg-stone-50 transition-colors' : ''}`}
            >
                {children}
            </div>
        );

        // --- Helper Functions ---

        const parseLocalDate = (dateString) => {
            if (!dateString) return new Date();
            const [year, month, day] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day);
        };

        const getLocalDateString = (d) => {
            const date = new Date(d);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- Sub-Components ---

        const Timeline = ({ 
            logs, 
            dateKey, 
            onDateChange,
            onDeleteLog, 
            onEditLog,
            onIconChange,
            isHistoryView = false 
        }) => {
            const [isEditing, setIsEditing] = useState(false);

            const formatTime = (isoString) => new Intl.DateTimeFormat('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }).format(new Date(isoString));
            const formatDate = (dateObj) => new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'short', day: 'numeric' }).format(dateObj);

            const dayLogs = logs.filter(log => getLocalDateString(log.date) === dateKey)
                .slice() // 配列をコピー
                .sort((a, b) => {
                    // 上が過去、下が現在の順（古い順）
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    // 日付が同じ場合は時刻で比較、異なる場合は日付で比較
                    if (dateA.getTime() < dateB.getTime()) return -1; // aが古い（上に）
                    if (dateA.getTime() > dateB.getTime()) return 1;  // bが古い（上に）
                    return 0;
                });

            const handleDateHeaderChange = (e) => {
                if (onDateChange) {
                    onDateChange(dateKey, e.target.value);
                }
            };

            const cycleIcon = (log) => {
                if (!isEditing || !onIconChange) return;
                const currentTypeIndex = LOG_TYPES.findIndex(t => t.id === log.type);
                const nextType = LOG_TYPES[(currentTypeIndex + 1) % LOG_TYPES.length];
                onIconChange(log.id, nextType.id);
            };

            return (
                <div className="space-y-3 print:space-y-2 pb-safe-content">
                <div className="flex justify-between items-end px-2 pt-6 mb-6 print:mb-2 print:pt-0">
                    <div className="w-full">
                        {isHistoryView && (
                            <div className="text-xs text-stone-400 font-medium uppercase tracking-wider mb-0.5">
                                {STRINGS.tab_history}
                            </div>
                        )}
                    
                        <h2 className="text-xl font-bold text-stone-800 tracking-tight">
                            {formatDate(parseLocalDate(dateKey))}
                        </h2>
                    </div>

                    <div className="flex items-center gap-2 print:hidden ml-4">
                        <EditToggleButton isEditing={isEditing} onClick={() => setIsEditing(!isEditing)} />
                    </div>
                </div>

                {dayLogs.length === 0 ? (
                    <div className="text-center py-20">
                    <p className="text-stone-300">{STRINGS.no_logs}</p>
                    </div>
                ) : (
                    <div className="space-y-2 relative before:absolute before:left-[17px] before:top-4 before:bottom-4 before:w-[2px] before:bg-stone-100">
                    {dayLogs.map((log) => {
                        const typeConfig = LOG_TYPES.find(l => l.id === log.type) || LOG_TYPES[LOG_TYPES.length - 1];
                        const Icon = typeConfig.icon;
                        // アイコン配色: Pellets, Veggies, Hay, Water, Critical Care, Medication → 薄いグレー背景、アクセントカラー
                        // Poop, Pee → アクセントカラー背景、白
                        const lightBgTypes = ['pellets', 'veggies', 'hay', 'water', 'treats', 'cc', 'meds'];
                        const isLightBg = lightBgTypes.includes(log.type);
                        
                        // 5段階評価タイプ
                        const ratingTypes = ['pellets', 'veggies', 'hay', 'water', 'treats', 'poop', 'pee'];
                        
                        // 5段階評価の表示用コンポーネント
                        const RatingDisplay = ({ amount }) => {
                            const rating = amount !== null && amount !== undefined ? parseInt(amount) : 0;
                            const options = [1, 2, 3, 4, 5];
                            const lightAccentColor = 'rgba(143, 176, 146, 0.4)';
                            
                            return (
                                <div className="flex items-center gap-0.5">
                                    {options.map((opt) => (
                                        <span 
                                            key={opt} 
                                            className="text-xs"
                                            style={{ 
                                                color: opt <= rating ? ACCENT_COLOR : lightAccentColor,
                                                fontSize: '0.7em'
                                            }}
                                        >
                                            {opt <= rating ? '●' : '○'}
                                        </span>
                                    ))}
                                </div>
                            );
                        };
                        
                        // 5段階評価タイプで、amountが空の場合は0として扱う
                        const shouldShowRating = ratingTypes.includes(log.type);
                        const ratingAmount = shouldShowRating ? (log.amount ? parseInt(log.amount) : 0) : null;
                        
                        return (
                        <div key={log.id} className="relative flex gap-3 items-center pl-0 print:break-inside-avoid">
                            <button 
                            onClick={(e) => {
                                if (isEditing) {
                                    e.stopPropagation();
                                    cycleIcon(log);
                                }
                            }}
                            disabled={!isEditing}
                            className={`z-10 w-9 h-9 rounded-full flex items-center justify-center shrink-0 shadow-sm transition-transform ${isEditing ? 'active:scale-90 hover:opacity-80 cursor-pointer' : ''}`}
                            style={isLightBg ? { backgroundColor: '#f5f5f4', color: ACCENT_COLOR } : { backgroundColor: ACCENT_COLOR, color: 'white' }}
                            >
                            <Icon size={16} strokeWidth={2} />
                            </button>
                            
                            <div 
                            className={`flex-1 bg-white rounded-xl p-3 border border-stone-100 shadow-sm print:border-stone-200 print:shadow-none flex justify-between items-center min-h-[48px] ${isEditing ? 'cursor-pointer hover:bg-stone-50' : ''}`}
                            onClick={() => isEditing && onEditLog(log)}
                            >
                            <div className="flex-1">
                                <div className="flex items-center">
                                <span className="font-bold text-stone-700 text-xs">
                                    {STRINGS.categories[log.type]}
                                </span>
                                </div>
                                <div className="text-xs text-stone-600 leading-relaxed mt-0.5 flex items-center gap-2 flex-wrap min-h-[16px]">
                                    {shouldShowRating ? (
                                        <>
                                            <RatingDisplay amount={ratingAmount} />
                                            {log.notes && <span className="text-stone-500">{log.notes}</span>}
                                        </>
                                    ) : log.amount ? (
                                        <>
                                            <span className="font-medium">
                                                {log.type === 'cc' && !log.amount.includes('g') ? `${log.amount}g` : 
                                                 log.type === 'meds' && !log.amount.includes('ml') ? `${log.amount}ml` : 
                                                 log.amount}
                                            </span>
                                            {log.notes && <span className="text-stone-500">{log.notes}</span>}
                                        </>
                                    ) : log.notes ? (
                                        <span className="text-stone-500">{log.notes}</span>
                                    ) : null}
                                </div>
                            </div>

                            <div className="flex items-center gap-2">
                                <span className="text-xs font-mono text-stone-400">
                                    {formatTime(log.date)}
                                </span>
                                {isEditing && (
                                    <button 
                                    onClick={(e) => { 
                                        e.stopPropagation(); 
                                        onDeleteLog(log.id); 
                                    }}
                                    className="p-1 text-stone-300 hover:text-red-500 transition-colors z-20"
                                    >
                                    <Trash2 size={16} />
                                    </button>
                                )}
                            </div>
                            </div>
                        </div>
                        );
                    })}
                    </div>
                )}
                </div>
            );
        };

        const HistoryScreen = ({ logs, onSelectDate, onDeleteLog, onDeleteLogs, onEditLog, onDateChange, onIconChange }) => {
            const [isEditing, setIsEditing] = useState(false);
            const formatDate = (isoString) => new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'short', day: 'numeric' }).format(parseLocalDate(isoString));
            
            const dates = [...new Set(logs.map(log => getLocalDateString(log.date)))].sort((a, b) => {
                // 日付文字列（YYYY-MM-DD）を比較して古い順にソート（上が過去、下が現在）
                return a.localeCompare(b);
            });

            const handleDeleteDate = (dateKey) => {
                const logsToDelete = logs.filter(l => getLocalDateString(l.date) === dateKey);
                const logCount = logsToDelete.length;
                if (logCount > 0 && window.confirm(`Delete all ${logCount} log${logCount > 1 ? 's' : ''} for ${formatDate(dateKey)}?`)) {
                    const logIds = logsToDelete.map(log => log.id);
                    onDeleteLogs(logIds);
                }
            };

            return (
                <>
                <div className="space-y-2 pb-safe-content print:hidden">
                <div className="flex items-center justify-between px-2 pt-6 mb-6">
                    <h2 className="text-xl font-bold text-stone-800">{STRINGS.tab_history}</h2>
                    <EditToggleButton isEditing={isEditing} onClick={() => setIsEditing(!isEditing)} />
                </div>
                {dates.length === 0 ? (
                    <div className="flex items-center justify-center py-12">
                        <p className="text-stone-300">{STRINGS.no_logs}</p>
                    </div>
                ) : (
                    dates.map(dateKey => (
                        <Card key={dateKey} onClick={() => !isEditing && onSelectDate(dateKey)} className={`flex items-center justify-between group py-2 ${isEditing ? 'cursor-default' : 'cursor-pointer'}`}>
                        <div>
                            <div className="font-bold text-stone-700 text-sm">{formatDate(dateKey)}</div>
                            <div className="text-xs text-stone-400">
                            {logs.filter(l => getLocalDateString(l.date) === dateKey).length} Records
                            </div>
                        </div>
                        {isEditing ? (
                            <button 
                                onClick={(e) => {
                                    e.stopPropagation();
                                    handleDeleteDate(dateKey);
                                }}
                                className="p-1 text-stone-300 hover:text-red-500 transition-colors"
                            >
                                <Trash2 size={18} />
                            </button>
                        ) : (
                            <ChevronRight className="text-stone-300 group-hover:text-stone-500 transition-colors" size={18} />
                        )}
                        </Card>
                    ))
                )}
                </div>
                
                {/* 印刷用: すべての日付の詳細を表示 */}
                <div className="hidden print:block space-y-6">
                <h2 className="text-2xl font-bold text-stone-800 mb-4">{STRINGS.tab_history}</h2>
                {dates.map(dateKey => (
                    <div key={`print-${dateKey}`} className="break-inside-avoid">
                        <Timeline 
                            logs={logs}
                            dateKey={dateKey}
                            onDateChange={onDateChange}
                            onDeleteLog={onDeleteLog}
                            onEditLog={onEditLog}
                            onIconChange={onIconChange}
                            isHistoryView={true}
                        />
                    </div>
                ))}
                </div>
                </>
            );
        };

        const SitterScreen = ({ careGuideItems, setCareGuideItems, emergencyContact, setEmergencyContact }) => {
            const [isEditingGuide, setIsEditingGuide] = useState(false);

            const handleGuideChange = (index, field, newVal) => {
                const newItems = [...careGuideItems];
                newItems[index][field] = newVal;
                setCareGuideItems(newItems);
            };

            const SITTER_TYPE_IDS = Object.keys(SITTER_ICON_MAP);

            const cycleIcon = (index) => {
                if (!isEditingGuide) return;
                const currentItem = careGuideItems[index];
                const currentIconId = currentItem.iconId || currentItem.id;
                const currentTypeIndex = SITTER_TYPE_IDS.indexOf(currentIconId);
                const nextId = SITTER_TYPE_IDS[(currentTypeIndex + 1) % SITTER_TYPE_IDS.length];
                
                const newItems = [...careGuideItems];
                newItems[index].iconId = nextId;
                // idは変更しない（カテゴリ名を保持）
                setCareGuideItems(newItems);
            };

            const deleteItem = (index) => {
                const newItems = careGuideItems.filter((_, i) => i !== index);
                setCareGuideItems(newItems);
            };

            const addItem = () => {
                setCareGuideItems([...careGuideItems, { id: 'pellets', title: '', text: '' }]);
            };

            return (
                <div className="pb-safe-content space-y-2">
                <div className="flex items-center justify-between px-2 pt-6 mb-4">
                    <h2 className="text-xl font-bold text-stone-800">{STRINGS.guide}</h2>
                    <div className="flex items-center gap-2 print:hidden">
                        <EditToggleButton isEditing={isEditingGuide} onClick={() => setIsEditingGuide(!isEditingGuide)} />
                    </div>
                </div>

                {careGuideItems.map((item, idx) => {
                    const iconId = item.iconId || item.id;
                    const Icon = SITTER_ICON_MAP[iconId] || Utensils;

                    return (
                    <div key={idx} className="flex gap-3 items-start p-3 bg-white rounded-xl border border-stone-100 print:border-stone-300 animate-scale-in">
                        <button 
                        onClick={() => cycleIcon(idx)}
                        disabled={!isEditingGuide}
                        className={`p-2 rounded-full shrink-0 transition-transform ${isEditingGuide ? 'active:scale-90 hover:opacity-80' : ''}`} 
                        style={{ backgroundColor: ACCENT_COLOR, color: 'white' }}
                        >
                        <Icon size={20} strokeWidth={2} />
                        </button>
                        <div className="flex-1">
                        {isEditingGuide ? (
                            <div className="space-y-1">
                            <input
                            type="text"
                            value={item.title !== undefined ? item.title : ''}
                            onChange={(e) => handleGuideChange(idx, 'title', e.target.value)}
                            className="w-full text-sm font-bold bg-stone-50 border border-stone-200 rounded px-2 py-1 focus:outline-none focus:border-[#8FB092]"
                            readOnly={false}
                            tabIndex={0}
                            autoComplete="off"
                            autoCorrect="off"
                            autoCapitalize="off"
                            spellCheck="false"
                            placeholder={STRINGS.sitter_sections[item.id] || STRINGS.categories[item.id] || ''}
                            onClick={(e) => {
                                e.stopPropagation();
                                setTimeout(() => e.target.focus(), 100);
                            }}
                            onTouchStart={(e) => {
                                e.stopPropagation();
                            }}
                            onTouchEnd={(e) => {
                                e.stopPropagation();
                                setTimeout(() => e.target.focus(), 100);
                            }}
                            />
                            <textarea
                            value={item.text}
                            onChange={(e) => handleGuideChange(idx, 'text', e.target.value)}
                            className="w-full text-sm bg-stone-50 border border-stone-200 rounded p-2 focus:outline-none focus:border-[#8FB092] resize-none"
                            rows={2}
                            readOnly={false}
                            tabIndex={0}
                            onClick={(e) => {
                                e.stopPropagation();
                                setTimeout(() => e.target.focus(), 100);
                            }}
                            onTouchStart={(e) => {
                                e.stopPropagation();
                            }}
                            onTouchEnd={(e) => {
                                e.stopPropagation();
                                setTimeout(() => e.target.focus(), 100);
                            }}
                            />
                            </div>
                        ) : (
                            <div>
                            <h3 className="font-bold text-stone-700 text-sm mb-1">{item.title || STRINGS.sitter_sections[item.id] || STRINGS.categories[item.id]}</h3>
                            <p className="text-stone-600 text-sm leading-relaxed">
                            {item.text}
                            </p>
                            </div>
                        )}
                        </div>
                        
                        {isEditingGuide && (
                        <button onClick={() => deleteItem(idx)} className="text-stone-300 hover:text-red-500 self-center p-1">
                            <Trash2 size={16} />
                        </button>
                        )}
                    </div>
                    );
                })}

                {isEditingGuide && (
                    <Button variant="secondary" onClick={addItem} className="w-full border-dashed">
                    <Plus size={18} /> Add Item
                    </Button>
                )}

                <div className="mt-4 p-4 bg-stone-50 rounded-xl border-l-4 border-[#8FB092] print:border-gray-400">
                    <h3 className="font-bold text-stone-700 mb-1 flex items-center gap-2 text-sm">
                    <Activity size={16} className="text-[#8FB092]" />
                    {STRINGS.sitter_sections.emergency}
                    </h3>
                    {isEditingGuide ? (
                    <textarea
                        value={emergencyContact}
                        onChange={(e) => setEmergencyContact(e.target.value)}
                        className="w-full text-sm bg-white border border-stone-200 rounded p-2 focus:outline-none focus:border-[#8FB092]"
                        rows={4}
                        readOnly={false}
                        tabIndex={0}
                        onClick={(e) => {
                            e.stopPropagation();
                            setTimeout(() => e.target.focus(), 100);
                        }}
                        onTouchStart={(e) => {
                            e.stopPropagation();
                        }}
                        onTouchEnd={(e) => {
                            e.stopPropagation();
                            setTimeout(() => e.target.focus(), 100);
                        }}
                    />
                    ) : (
                    <p className="text-stone-600 text-sm whitespace-pre-line leading-relaxed">
                        {emergencyContact}
                    </p>
                    )}
                </div>
                </div>
            );
        };

        // 体重ピッカーコンポーネント（0.1kg単位）
        const WeightPicker = ({ value, onChange }) => {
            const [selectedValue, setSelectedValue] = useState(value || '');
            
            useEffect(() => {
                if (value !== undefined) {
                    setSelectedValue(value);
                }
            }, [value]);
            
            const handleChange = (newValue) => {
                setSelectedValue(newValue);
                onChange(newValue);
            };
            
            const options = [];
            for (let i = 0; i <= 100; i++) {
                options.push((i / 10).toFixed(1));
            }
            
            // valueからkgを除去して数値のみを取得
            const currentValue = selectedValue ? selectedValue.replace('kg', '').trim() : '';
            
            return (
                <div className="relative">
                    <select
                        value={currentValue}
                        onChange={(e) => handleChange(`${e.target.value}kg`)}
                        className="bg-stone-50 rounded px-2 py-1 text-right outline-none text-stone-700 w-24 text-sm appearance-none"
                    >
                        {options.map((opt) => (
                            <option key={opt} value={opt}>
                                {opt}kg
                            </option>
                        ))}
                    </select>
                </div>
            );
        };

        const ProfileScreen = ({ profile, setProfile, careGuideItems, emergencyContact }) => {
            const [isEditingProfile, setIsEditingProfile] = useState(false);
            const [tempProfile, setTempProfile] = useState({});

            const handleSaveProfile = () => {
                setProfile(tempProfile);
                setIsEditingProfile(false);
            };

            const startEditing = () => {
                setTempProfile({ ...profile });
                setIsEditingProfile(true);
            };

            return (
                <div className="pb-safe-content space-y-3 overflow-hidden">
                <div className="flex justify-end items-center px-2 pt-6">
                    <div className="print:hidden">
                        <EditToggleButton isEditing={isEditingProfile} onClick={isEditingProfile ? handleSaveProfile : startEditing} />
                    </div>
                </div>

                <div className="flex flex-col items-center py-3">
                    {!isEditingProfile ? (
                        <div className="text-center">
                            <h3 className="text-2xl font-bold text-stone-800">{profile.name}</h3>
                            <div className="text-stone-500 mt-1 flex items-center justify-center gap-2 text-sm">
                                <span>{profile.gender === 'male' ? STRINGS.male : STRINGS.female}</span>
                                <span>•</span>
                                <span>{new Date().getFullYear() - new Date(profile.birthday).getFullYear()} y</span>
                            </div>
                        </div>
                    ) : (
                        <input 
                            type="text" 
                            value={tempProfile.name} 
                            onChange={e => setTempProfile({...tempProfile, name: e.target.value})}
                            className="text-center text-xl font-bold bg-stone-50 border-b border-stone-300 focus:border-[#8FB092] outline-none px-2 py-1 w-2/3"
                            readOnly={false}
                            tabIndex={0}
                            onClick={(e) => {
                                e.stopPropagation();
                                setTimeout(() => e.target.focus(), 100);
                            }}
                            onTouchStart={(e) => {
                                e.stopPropagation();
                            }}
                            onTouchEnd={(e) => {
                                e.stopPropagation();
                                setTimeout(() => e.target.focus(), 100);
                            }}
                        />
                    )}
                </div>

                <div className="grid grid-cols-1 gap-2">
                    {isEditingProfile && (
                        <Card className="flex items-center justify-between py-3 min-h-[48px]">
                            <span className="text-sm text-stone-400">{STRINGS.gender}</span>
                            <div className="flex gap-2">
                                <button 
                                    onClick={() => setTempProfile({...tempProfile, gender: 'male'})}
                                    className={`px-3 py-1 rounded-lg text-sm ${tempProfile.gender === 'male' ? 'bg-[#8FB092] text-white' : 'bg-stone-100 text-stone-400'}`}
                                >
                                    {STRINGS.male}
                                </button>
                                <button 
                                    onClick={() => setTempProfile({...tempProfile, gender: 'female'})}
                                    className={`px-3 py-1 rounded-lg text-sm ${tempProfile.gender === 'female' ? 'bg-[#8FB092] text-white' : 'bg-stone-100 text-stone-400'}`}
                                >
                                    {STRINGS.female}
                                </button>
                            </div>
                        </Card>
                    )}

                    <Card className="flex items-center justify-between py-3 min-h-[48px]">
                        <Cake size={18} style={{ color: ACCENT_COLOR }} />
                        {isEditingProfile ? (
                            <input 
                                type="date" 
                                value={tempProfile.birthday} 
                                onChange={e => setTempProfile({...tempProfile, birthday: e.target.value})}
                                className="bg-stone-50 rounded px-2 py-1 text-right outline-none text-stone-700 text-sm"
                                readOnly={false}
                                tabIndex={0}
                                onClick={(e) => {
                                    e.stopPropagation();
                                    setTimeout(() => e.target.focus(), 100);
                                }}
                                onTouchStart={(e) => {
                                    e.stopPropagation();
                                }}
                                onTouchEnd={(e) => {
                                    e.stopPropagation();
                                    setTimeout(() => e.target.focus(), 100);
                                }}
                            />
                        ) : (
                            <span className="font-medium text-stone-700 text-sm">{profile.birthday}</span>
                        )}
                    </Card>

                    <Card className="flex items-center justify-between py-3 min-h-[48px]">
                        <Scale size={18} style={{ color: ACCENT_COLOR }} />
                        {isEditingProfile ? (
                            <WeightPicker 
                                value={tempProfile.weight} 
                                onChange={(val) => setTempProfile({...tempProfile, weight: val})}
                            />
                        ) : (
                            <span className="font-medium text-stone-700 text-sm">{profile.weight}</span>
                        )}
                    </Card>

                    <Card className="flex items-center justify-between py-3 min-h-[48px]">
                        <Heart size={18} style={{ color: ACCENT_COLOR }} />
                        {isEditingProfile ? (
                            <input 
                                type="text" 
                                value={tempProfile.likes} 
                                onChange={e => setTempProfile({...tempProfile, likes: e.target.value})}
                                className="bg-stone-50 rounded px-2 py-1 text-right outline-none text-stone-700 text-sm flex-1 ml-4"
                                placeholder="Comma separated"
                                readOnly={false}
                                tabIndex={0}
                                onClick={(e) => {
                                    e.stopPropagation();
                                    setTimeout(() => e.target.focus(), 100);
                                }}
                                onTouchStart={(e) => {
                                    e.stopPropagation();
                                }}
                                onTouchEnd={(e) => {
                                    e.stopPropagation();
                                    setTimeout(() => e.target.focus(), 100);
                                }}
                            />
                        ) : (
                            <div className="flex items-center gap-1.5 flex-wrap justify-end">
                                {profile.likes.split(',').map((like, i) => (
                                    <span key={i} className="px-2.5 py-0.5 bg-stone-100 text-stone-600 rounded-lg text-xs whitespace-nowrap">
                                        {like.trim()}
                                    </span>
                                ))}
                            </div>
                        )}
                    </Card>
                </div>

                {/* 印刷用: Care Guideの内容を表示 */}
                <div className="hidden print:block mt-8 space-y-4">
                    <h2 className="text-2xl font-bold text-stone-800 mb-4">{STRINGS.guide}</h2>
                    
                    {careGuideItems && careGuideItems.length > 0 && careGuideItems.map((item, idx) => {
                        const iconId = item.iconId || item.id;
                        const Icon = SITTER_ICON_MAP[iconId] || Utensils;
                        
                        return (
                            <div key={idx} className="flex gap-3 items-start p-3 bg-white rounded-xl border border-stone-300">
                                <div className="p-2 rounded-full shrink-0" style={{ backgroundColor: ACCENT_COLOR, color: 'white' }}>
                                    <Icon size={20} strokeWidth={2} />
                                </div>
                                <div className="flex-1">
                                    <h3 className="font-bold text-stone-700 text-sm mb-1">{item.title || STRINGS.sitter_sections[item.id] || STRINGS.categories[item.id]}</h3>
                                    <p className="text-stone-600 text-sm leading-relaxed">
                                        {item.text}
                                    </p>
                                </div>
                            </div>
                        );
                    })}

                    <div className="mt-4 p-4 bg-stone-50 rounded-xl border-l-4 border-gray-400">
                        <h3 className="font-bold text-stone-700 mb-1 flex items-center gap-2 text-sm">
                            <Activity size={16} className="text-[#8FB092]" />
                            {STRINGS.sitter_sections.emergency}
                        </h3>
                        <p className="text-stone-600 text-sm whitespace-pre-line leading-relaxed">
                            {emergencyContact}
                        </p>
                    </div>
                </div>
                </div>
            );
        };

        const App = () => {
            const getTodayKey = () => getLocalDateString(new Date());

            const [activeTab, setActiveTab] = useState('today');
            const [selectedDateKey, setSelectedDateKey] = useState(getTodayKey()); 
            const [selectedHistoryDate, setSelectedHistoryDate] = useState(null); // Fixed ReferenceError
            
            const [isFabOpen, setIsFabOpen] = useState(false);
            const [isDatePickerOpen, setIsDatePickerOpen] = useState(false);
            const [modalOpen, setModalOpen] = useState(false);
            const [selectedLogType, setSelectedLogType] = useState(null);
            const [editLogData, setEditLogData] = useState(null); 

            // localStorageからデータを読み込む
            const loadFromStorage = (key, defaultValue) => {
                try {
                    const item = localStorage.getItem(`dotty_${key}`);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (e) {
                    console.error(`Error loading ${key} from localStorage:`, e);
                    return defaultValue;
                }
            };

            // localStorageにデータを保存する
            const saveToStorage = (key, value) => {
                try {
                    localStorage.setItem(`dotty_${key}`, JSON.stringify(value));
                } catch (e) {
                    console.error(`Error saving ${key} to localStorage:`, e);
                }
            };

            const [logs, setLogs] = useState(() => loadFromStorage('logs', []));
            const [profile, setProfile] = useState(() => loadFromStorage('profile', {
                name: 'Mugi',
                gender: 'Male',
                birthday: '2019-09-15',
                weight: '1.8kg',
                likes: 'Dill, Rettuce',
                memo: '',
                photo: null
            }));
            const [careGuideItems, setCareGuideItems] = useState(() => loadFromStorage('careGuideItems', []));
            const [emergencyContact, setEmergencyContact] = useState(() => loadFromStorage('emergencyContact', `Clinic: ABC Exotics Vet\nPhone: 123-456-7890\nAddress: 123 Rabbit Lane, Toronto\nOwner: 090-0000-0000 (Line/WhatsApp)`));

            // logsが変更されたときにlocalStorageに保存
            useEffect(() => {
                saveToStorage('logs', logs);
            }, [logs]);

            // profileが変更されたときにlocalStorageに保存
            useEffect(() => {
                saveToStorage('profile', profile);
            }, [profile]);

            // careGuideItemsが変更されたときにlocalStorageに保存
            useEffect(() => {
                saveToStorage('careGuideItems', careGuideItems);
            }, [careGuideItems]);

            // emergencyContactが変更されたときにlocalStorageに保存
            useEffect(() => {
                saveToStorage('emergencyContact', emergencyContact);
            }, [emergencyContact]);

            const handlePrint = () => {
                window.print();
            };

            const handleAddLogClick = (typeId) => {
                setSelectedLogType(typeId);
                setEditLogData(null);
                setIsFabOpen(false);
                setModalOpen(true);
            };

            const handleDateSelect = (dateKey) => {
                setSelectedDateKey(dateKey);
                setActiveTab('today');
                setIsDatePickerOpen(false);
            };

            const handleDeleteLog = useCallback((id) => {
                if (window.confirm(STRINGS.confirm_delete)) {
                    setLogs((prev) => prev.filter(l => l.id !== id));
                }
            }, []);

            const handleDeleteLogs = useCallback((ids) => {
                setLogs((prev) => prev.filter(l => !ids.includes(l.id)));
            }, []);

            const handleEditLog = useCallback((log) => {
                setSelectedLogType(log.type);
                setEditLogData(log);
                setModalOpen(true);
            }, []);

            const handleIconChange = useCallback((logId, newTypeId) => {
                setLogs((prev) => prev.map(log => 
                    log.id === logId ? { ...log, type: newTypeId } : log
                ));
            }, []);

            const handleDateChange = (oldDateKey, newDateString) => {
                setLogs((prev) => prev.map(log => {
                    const logDateKey = getLocalDateString(log.date);

                    if (logDateKey === oldDateKey) {
                        const logDate = new Date(log.date);
                        const hours = logDate.getHours();
                        const minutes = logDate.getMinutes();
                        const seconds = logDate.getSeconds();
                        
                        const [ny, nm, nd] = newDateString.split('-').map(Number);
                        const newDate = new Date(ny, nm - 1, nd, hours, minutes, seconds);
                        
                        return { ...log, date: newDate.toISOString() };
                    }
                    return log;
                }));
                setSelectedDateKey(newDateString);
            };

            const saveLog = (data) => {
                let baseDate;
                if (editLogData) {
                    baseDate = new Date(editLogData.date);
                } else {
                    baseDate = parseLocalDate(selectedDateKey);
                    const now = new Date();
                    if (selectedDateKey === getTodayKey()) {
                        baseDate.setHours(now.getHours(), now.getMinutes());
                    } else {
                        baseDate.setHours(12, 0); 
                    }
                }

                const [hours, minutes] = data.time.split(':');
                baseDate.setHours(parseInt(hours), parseInt(minutes));

                if (editLogData) {
                    setLogs((prev) => prev.map(l => l.id === editLogData.id ? {
                        ...l,
                        type: selectedLogType,
                        date: baseDate.toISOString(),
                        amount: data.amount,
                        notes: data.notes
                    } : l));
                } else {
                    const newLog = {
                        id: Date.now(),
                        type: selectedLogType,
                        date: baseDate.toISOString(),
                        amount: data.amount,
                        notes: data.notes
                    };
                    setLogs((prev) => [newLog, ...prev]);
                }
                
                setModalOpen(false);
                setEditLogData(null);
                
                // 入力後、見出しの位置までスクロール
                setTimeout(() => {
                    const mainContent = document.getElementById('main-content');
                    if (mainContent) {
                        mainContent.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                }, 100);
            };

            const FabMenu = () => {
                if (!isFabOpen) return null;
                return (
                <>
                    <div className="fixed inset-0 bg-stone-900/20 backdrop-blur-[1px] z-40 transition-opacity" onClick={() => setIsFabOpen(false)} />
                    <div className="fixed left-1/2 top-20 z-50 flex flex-col items-center animate-scale-in" style={{ maxWidth: 'calc(100vw - 32px)', transform: 'translateX(-50%)', maxHeight: 'calc(100vh - 140px)', overflow: 'hidden' }}>
                        <div className="bg-white rounded-xl shadow-xl border border-stone-100 p-2 min-w-[200px] max-w-[90vw] flex flex-col gap-0.5 overflow-y-auto" style={{ maxHeight: 'calc(100vh - 160px)' }}>
                            <div className="px-3 py-1.5 text-xs font-bold text-stone-400 uppercase tracking-wider">{STRINGS.select_type}</div>
                            {LOG_TYPES.map((type) => (
                                <button 
                                    key={type.id}
                                    onClick={() => handleAddLogClick(type.id)}
                                    className="w-full flex items-center gap-3 px-3 py-2 hover:bg-stone-50 rounded-lg transition-colors text-left"
                                >
                                    <div className="p-1.5 rounded-full shrink-0 flex items-center justify-center" style={(['pellets', 'veggies', 'hay', 'water', 'treats', 'cc', 'meds'].includes(type.id)) ? { backgroundColor: '#f5f5f4', color: ACCENT_COLOR } : { backgroundColor: ACCENT_COLOR, color: 'white' }}>
                                        <type.icon size={18} />
                                    </div>
                                    <span className="text-stone-700 font-medium text-sm">{STRINGS.categories[type.id]}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                </>
                );
            };

            const DatePickerModal = () => {
                const [currentMonth, setCurrentMonth] = useState(new Date());
                const [showYearMonthPicker, setShowYearMonthPicker] = useState(false);
                
                if (!isDatePickerOpen) return null;
                
                const today = new Date();
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth();
                
                // 月の最初の日と最後の日を取得
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                
                // カレンダーの最初の日（前月の最後の週の日曜日から開始）
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - startDate.getDay());
                
                // カレンダーの最後の日（次月の最初の週の土曜日まで）
                const endDate = new Date(lastDay);
                endDate.setDate(endDate.getDate() + (6 - endDate.getDay()));
                
                // カレンダーの日付配列を生成
                const calendarDays = [];
                const currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                    calendarDays.push(new Date(currentDate));
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                
                // 年と月の選択用の配列を生成
                const currentYear = today.getFullYear();
                const years = [];
                for (let i = currentYear - 10; i <= currentYear + 10; i++) {
                    years.push(i);
                }
                
                const isToday = (date) => {
                    return getLocalDateString(date.toISOString()) === getTodayKey();
                };
                
                const isCurrentMonth = (date) => {
                    return date.getMonth() === month;
                };
                
                const handlePrevMonth = () => {
                    setCurrentMonth(new Date(year, month - 1, 1));
                };
                
                const handleNextMonth = () => {
                    setCurrentMonth(new Date(year, month + 1, 1));
                };
                
                const handleYearChange = (newYear) => {
                    setCurrentMonth(new Date(newYear, month, 1));
                    setShowYearMonthPicker(false);
                };
                
                const handleMonthChange = (newMonth) => {
                    setCurrentMonth(new Date(year, newMonth, 1));
                    setShowYearMonthPicker(false);
                };
                
                const handleDateClick = (date) => {
                    const dateKey = getLocalDateString(date.toISOString());
                    handleDateSelect(dateKey);
                };

                return (
                <>
                    <div className="fixed inset-0 bg-stone-900/20 backdrop-blur-[1px] z-40 transition-opacity" onClick={() => setIsDatePickerOpen(false)} />
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 animate-scale-in">
                        <div className="bg-white rounded-xl shadow-xl border border-stone-100 p-4 w-full max-w-[320px] mx-auto">
                            {!showYearMonthPicker ? (
                                <>
                                    {/* ヘッダー: 月と年の表示、前後の月へのナビゲーション */}
                                    <div className="flex items-center justify-between mb-4">
                                        <button 
                                            onClick={handlePrevMonth}
                                            className="p-2 rounded-full hover:bg-stone-100 transition-colors text-stone-600"
                                        >
                                            <ChevronLeft size={20} />
                                        </button>
                                        <button
                                            onClick={() => setShowYearMonthPicker(true)}
                                            className="text-lg font-bold text-stone-800 hover:text-[#8FB092] transition-colors px-2 py-1"
                                        >
                                            {monthNames[month]} {year}
                                        </button>
                                        <button 
                                            onClick={handleNextMonth}
                                            className="p-2 rounded-full hover:bg-stone-100 transition-colors text-stone-600"
                                        >
                                            <ChevronRight size={20} />
                                        </button>
                                    </div>
                                    
                                    {/* 週のヘッダー */}
                                    <div className="grid grid-cols-7 gap-1 mb-2">
                                        {weekDays.map((day) => (
                                            <div key={day} className="text-center text-xs font-medium text-stone-500 py-1">
                                                {day}
                                            </div>
                                        ))}
                                    </div>
                                    
                                    {/* カレンダーの日付グリッド */}
                                    <div className="grid grid-cols-7 gap-1">
                                        {calendarDays.map((date, idx) => {
                                            const dateKey = getLocalDateString(date.toISOString());
                                            const dayIsToday = isToday(date);
                                            const dayIsCurrentMonth = isCurrentMonth(date);
                                            
                                            return (
                                                <button
                                                    key={idx}
                                                    onClick={() => handleDateClick(date)}
                                                    className={`
                                                        aspect-square flex items-center justify-center text-sm transition-colors
                                                        ${dayIsCurrentMonth 
                                                            ? dayIsToday 
                                                                ? 'bg-[#8FB092] text-white font-bold rounded-full' 
                                                                : 'text-stone-700 hover:bg-stone-100 rounded-lg' 
                                                            : 'text-stone-300 hover:bg-stone-50 rounded-lg'
                                                        }
                                                    `}
                                                >
                                                    {date.getDate()}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </>
                            ) : (
                                <>
                                    {/* 年と月の選択画面 */}
                                    <div className="mb-4">
                                        <button
                                            onClick={() => setShowYearMonthPicker(false)}
                                            className="text-sm text-stone-500 hover:text-stone-700 mb-3 flex items-center gap-1"
                                        >
                                            <ChevronLeft size={16} />
                                            Back
                                        </button>
                                        <div className="text-lg font-bold text-stone-800 mb-4 text-center">Select Year & Month</div>
                                        
                                        {/* 年の選択 */}
                                        <div className="mb-4">
                                            <div className="text-xs font-medium text-stone-500 mb-2">Year</div>
                                            <div className="grid grid-cols-4 gap-2 max-h-[200px] overflow-y-auto">
                                                {years.map((y) => (
                                                    <button
                                                        key={y}
                                                        onClick={() => handleYearChange(y)}
                                                        className={`px-3 py-2 rounded-lg text-sm transition-colors ${
                                                            y === year 
                                                                ? 'bg-[#8FB092] text-white font-bold' 
                                                                : 'bg-stone-100 text-stone-700 hover:bg-stone-200'
                                                        }`}
                                                    >
                                                        {y}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        
                                        {/* 月の選択 */}
                                        <div>
                                            <div className="text-xs font-medium text-stone-500 mb-2">Month</div>
                                            <div className="grid grid-cols-3 gap-2">
                                                {monthNames.map((monthName, idx) => (
                                                    <button
                                                        key={idx}
                                                        onClick={() => handleMonthChange(idx)}
                                                        className={`px-3 py-2 rounded-lg text-sm transition-colors ${
                                                            idx === month 
                                                                ? 'bg-[#8FB092] text-white font-bold' 
                                                                : 'bg-stone-100 text-stone-700 hover:bg-stone-200'
                                                        }`}
                                                    >
                                                        {monthName.substring(0, 3)}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                </>
                );
            };

            // ドラムロールピッカーコンポーネント
            const DrumRollPicker = ({ value, onChange, type }) => {
                const [selectedValue, setSelectedValue] = useState(value || '');
                
                useEffect(() => {
                    if (value !== undefined) {
                        setSelectedValue(value);
                    }
                }, [value]);
                
                const handleChange = (newValue) => {
                    setSelectedValue(newValue);
                    onChange(newValue);
                };
                
                // 5段階評価タイプ（Pellets, Veggies, Hay, Water, Treats, Poop, Pee）
                if (['pellets', 'veggies', 'hay', 'water', 'treats', 'poop', 'pee'].includes(type)) {
                    const options = [1, 2, 3, 4, 5];
                    
                    return (
                        <div className="relative">
                            <select
                                name="amount"
                                value={selectedValue}
                                onChange={(e) => handleChange(e.target.value)}
                                className="w-full bg-stone-50 border border-stone-200 rounded-lg px-3 py-3 text-stone-700 focus:outline-none focus:border-[#8FB092] text-center appearance-none"
                                style={{ height: '50px' }}
                            >
                                <option value="">5段階評価</option>
                                {options.map((opt) => (
                                    <option key={opt} value={opt}>
                                        {opt}
                                    </option>
                                ))}
                            </select>
                        </div>
                    );
                }
                
                // Critical Care（1g単位、0-100g）
                if (type === 'cc') {
                    const options = [];
                    for (let i = 0; i <= 100; i++) {
                        options.push(i);
                    }
                    const currentValue = selectedValue ? parseFloat(selectedValue) : 0;
                    
                    return (
                        <div className="relative">
                            <div className="flex items-center gap-2">
                                <div className="flex-1 overflow-hidden">
                                    <select
                                        name="amount"
                                        value={selectedValue}
                                        onChange={(e) => handleChange(e.target.value)}
                                        className="w-full bg-stone-50 border border-stone-200 rounded-lg px-3 py-3 text-stone-700 focus:outline-none focus:border-[#8FB092] text-center appearance-none"
                                        style={{ height: '50px' }}
                                    >
                                        {options.map((opt) => (
                                            <option key={opt} value={opt}>
                                                {opt}g
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                        </div>
                    );
                }
                
                // Medication（0.1ml単位、0-10ml）
                if (type === 'meds') {
                    const options = [];
                    for (let i = 0; i <= 100; i++) {
                        options.push((i / 10).toFixed(1));
                    }
                    
                    return (
                        <div className="relative">
                            <div className="flex items-center gap-2">
                                <div className="flex-1 overflow-hidden">
                                    <select
                                        name="amount"
                                        value={selectedValue}
                                        onChange={(e) => handleChange(e.target.value)}
                                        className="w-full bg-stone-50 border border-stone-200 rounded-lg px-3 py-3 text-stone-700 focus:outline-none focus:border-[#8FB092] text-center appearance-none"
                                        style={{ height: '50px' }}
                                    >
                                        {options.map((opt) => (
                                            <option key={opt} value={opt}>
                                                {opt}ml
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                        </div>
                    );
                }
                
                // その他のタイプは通常のテキスト入力
                return (
                    <input 
                        name="amount" 
                        type="text" 
                        value={selectedValue}
                        onChange={(e) => handleChange(e.target.value)}
                        placeholder="..."
                        className="w-full bg-stone-50 border border-stone-200 rounded-lg px-3 text-stone-700 focus:outline-none focus:border-[#8FB092] h-[50px]" 
                        readOnly={false}
                        tabIndex={0}
                        onClick={(e) => {
                            e.stopPropagation();
                            setTimeout(() => e.target.focus(), 100);
                        }}
                        onTouchStart={(e) => {
                            e.stopPropagation();
                        }}
                        onTouchEnd={(e) => {
                            e.stopPropagation();
                            setTimeout(() => e.target.focus(), 100);
                        }}
                    />
                );
            };

            const EntryModal = () => {
                if (!modalOpen) return null;
                const type = LOG_TYPES.find(t => t.id === selectedLogType);
                if (!type) return null;
                const Icon = type.icon;
                
                const [amountValue, setAmountValue] = useState(editLogData ? editLogData.amount : '');
                
                // selectedLogTypeが変わったときにamountValueをリセット
                useEffect(() => {
                    if (!editLogData) {
                        setAmountValue('');
                    }
                }, [selectedLogType]);
                
                let initialTimeStr;
                if (editLogData) {
                    const d = new Date(editLogData.date);
                    initialTimeStr = `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
                } else {
                    const now = new Date();
                    initialTimeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                }

                return (
                <div className="fixed inset-0 z-50 flex items-start justify-center p-4 pt-10">
                    <div className="absolute inset-0 bg-stone-900/30 backdrop-blur-sm transition-opacity" onClick={() => setModalOpen(false)} />
                    <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl relative z-10 animate-scale-in">
                        <div className="flex justify-between items-center mb-6">
                            <div className="flex items-center gap-3">
                                <div className="p-2 rounded-lg text-white" style={{ backgroundColor: ACCENT_COLOR }}>
                                    <Icon size={24} />
                                </div>
                                <h3 className="text-lg font-bold text-stone-800">
                                    {editLogData ? STRINGS.edit : ''} {STRINGS.categories[type.id]}
                                </h3>
                            </div>
                            <button onClick={() => setModalOpen(false)} className="p-1 rounded-full hover:bg-stone-100 text-stone-400">
                                <X size={24} />
                            </button>
                        </div>

                        <form onSubmit={(e) => {
                            e.preventDefault();
                            const formData = new FormData(e.target);
                            saveLog({
                                amount: amountValue || formData.get('amount') || '',
                                notes: formData.get('notes'),
                                time: formData.get('time')
                            });
                        }} className="space-y-4">
                            
                            <div className="flex gap-6">
                                <div className="w-1/3">
                                    <label className="block text-xs font-bold text-stone-400 uppercase mb-1">{STRINGS.time}</label>
                                    <input 
                                        name="time" 
                                        type="time" 
                                        defaultValue={initialTimeStr}
                                        className="w-full bg-stone-50 border border-stone-200 rounded-lg px-3 text-stone-700 focus:outline-none focus:border-[#8FB092] h-[50px]" 
                                        readOnly={false}
                                        tabIndex={0}
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            setTimeout(() => e.target.focus(), 100);
                                        }}
                                        onTouchStart={(e) => {
                                            e.stopPropagation();
                                        }}
                                        onTouchEnd={(e) => {
                                            e.stopPropagation();
                                            setTimeout(() => e.target.focus(), 100);
                                        }}
                                    />
                                </div>
                                <div className="flex-1">
                                    <label className="block text-xs font-bold text-stone-400 uppercase mb-1">{STRINGS.amount}</label>
                                    <DrumRollPicker 
                                        value={amountValue}
                                        onChange={setAmountValue}
                                        type={selectedLogType}
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-stone-400 uppercase mb-1">{STRINGS.notes}</label>
                                <textarea 
                                    name="notes"
                                    defaultValue={editLogData ? editLogData.notes : ''}
                                    rows="3"
                                    className="w-full bg-stone-50 border border-stone-200 rounded-lg px-3 py-2 text-stone-700 focus:outline-none focus:border-[#8FB092] resize-none" 
                                    readOnly={false}
                                    tabIndex={0}
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        setTimeout(() => e.target.focus(), 100);
                                    }}
                                    onTouchStart={(e) => {
                                        e.stopPropagation();
                                    }}
                                    onTouchEnd={(e) => {
                                        e.stopPropagation();
                                        setTimeout(() => e.target.focus(), 100);
                                    }}
                                />
                            </div>

                            <div className="pt-2">
                                <Button type="submit" variant="primary" className="w-full">
                                    {STRINGS.save}
                                </Button>
                            </div>
                        </form>
                    </div>
                </div>
                );
            };

            const NavIcon = ({ icon: Icon, isActive, onClick }) => (
                <button 
                    onClick={onClick}
                    className={`flex items-center justify-center p-2 rounded-xl transition-all duration-300 ${isActive ? 'text-[#8FB092] bg-stone-50' : 'text-stone-300 hover:text-stone-400'}`}
                >
                    <Icon size={24} strokeWidth={isActive ? 2.5 : 2} />
                </button>
            );

            return (
                <div className="h-screen flex flex-col bg-[#FDFDFD] font-sans text-[#44403C] overflow-hidden print:bg-white print:h-auto print:overflow-visible">
                    <header className="fixed top-0 left-0 right-0 bg-[#FDFDFD] px-[13px] py-3 flex justify-between items-center border-b border-stone-100 z-30 print:hidden" style={{ backgroundColor: '#FDFDFD' }}>
                        <div className="flex items-center gap-2">
                        <img 
                            src="https://conizm.cc/dotty/images/dotty_logo_yoko.png" 
                            alt="Logo" 
                            className="object-contain" 
                            style={{ height: '25.6px', width: 'auto', transform: 'scale(0.8)' }}
                        />
                        </div>

                        <div className="flex gap-2">
                            <button onClick={handlePrint} className="p-2 rounded-full text-stone-400 hover:bg-stone-100 transition-colors flex items-center gap-2 text-sm font-medium">
                                <Printer size={20} />
                            </button>
                        </div>
                    </header>

                    <main className="flex-1 overflow-y-auto overflow-x-hidden px-4 py-4 max-w-md mx-auto w-full pt-[60px] pb-[120px] print:max-w-none print:px-0 print:py-0 print:pt-0 print:pb-0 print:overflow-visible no-scrollbar" id="main-content">
                        {activeTab === 'today' && (
                            <Timeline 
                                logs={logs} 
                                dateKey={selectedDateKey} 
                                onDeleteLog={handleDeleteLog}
                                onEditLog={handleEditLog}
                                onDateChange={handleDateChange}
                                onIconChange={handleIconChange}
                            />
                        )}
                        
                        {activeTab === 'history' && !selectedHistoryDate && (
                        <HistoryScreen 
                            logs={logs} 
                            onSelectDate={(date) => {
                                setSelectedHistoryDate(date);
                                setSelectedDateKey(date);
                                setActiveTab('today'); 
                            }}
                            onDeleteLog={handleDeleteLog}
                            onDeleteLogs={handleDeleteLogs}
                            onEditLog={handleEditLog}
                            onDateChange={handleDateChange}
                            onIconChange={handleIconChange}
                        />
                        )}

                        {activeTab === 'sitter' && (
                        <SitterScreen 
                            careGuideItems={careGuideItems} 
                            setCareGuideItems={setCareGuideItems} 
                            emergencyContact={emergencyContact}
                            setEmergencyContact={setEmergencyContact}
                        />
                        )}
                        
                        {activeTab === 'profile' && <ProfileScreen profile={profile} setProfile={setProfile} careGuideItems={careGuideItems} emergencyContact={emergencyContact} />}
                    </main>

                    {!isFabOpen && !isDatePickerOpen && (activeTab === 'today' || activeTab === 'history') && (
                        <button 
                        onClick={() => {
                            if (activeTab === 'history') {
                                setIsDatePickerOpen(true);
                            } else {
                                setIsFabOpen(true);
                            }
                        }}
                        className="fixed bottom-[120px] right-6 z-30 w-14 h-14 bg-[#8FB092] rounded-full shadow-lg shadow-[#8FB092]/30 text-white flex items-center justify-center transition-transform active:scale-90 print:hidden"
                        >
                        <Plus size={28} strokeWidth={2.5} />
                        </button>
                    )}

                    <FabMenu />
                    <DatePickerModal />
                    <EntryModal />

                    <nav className="fixed bottom-[30px] left-0 right-0 bg-[#FDFDFD] border-t border-stone-100 px-8 py-3 pb-safe z-30 print:hidden" style={{ backgroundColor: '#FDFDFD' }}>
                        <div className="max-w-md mx-auto flex justify-between items-center">
                        <NavIcon 
                            icon={Calendar} 
                            isActive={activeTab === 'today' && selectedDateKey === getTodayKey()} 
                            onClick={() => { setActiveTab('today'); setSelectedDateKey(getTodayKey()); setIsFabOpen(false); setSelectedHistoryDate(null); }} 
                        />
                        <NavIcon 
                            icon={History} 
                            isActive={activeTab === 'history' || (activeTab === 'today' && selectedDateKey !== getTodayKey())} 
                            onClick={() => { setActiveTab('history'); setSelectedHistoryDate(null); setIsFabOpen(false); }} 
                        />
                        <NavIcon 
                            icon={ClipboardList} 
                            isActive={activeTab === 'sitter'} 
                            onClick={() => { setActiveTab('sitter'); setIsFabOpen(false); setSelectedHistoryDate(null); }} 
                        />
                        <NavIcon 
                            icon={Heart} 
                            isActive={activeTab === 'profile'} 
                            onClick={() => { setActiveTab('profile'); setIsFabOpen(false); setSelectedHistoryDate(null); }} 
                        />
                        </div>
                    </nav>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // Service Worker登録
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/dotty/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch((error) => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
